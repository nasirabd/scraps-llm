name: Export ONNX & Publish

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "export/**"
      - "src/**"
      - "configs/**"
      - "tokenizer/**"

jobs:
  export-and-publish:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      HF_REPO:  donribbs/scraps-llm-model  
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          # minimal deps for export (adjust if needed)
          pip install torch onnx onnxruntime huggingface_hub pyyaml

      - name: Export ONNX (script lives in export/)
        run: |
          python export/export_onnx.py \
            --config configs/train_small.yaml \
            --ckpt model/checkpoints \
            --out export/scraps.onnx \
            --seq_len 256 \
            --opset 17 \
            --check

      - name: Upload artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: scraps-onnx
          path: |
            export/scraps.onnx
            tokenizer/bpe.json

      - name: Publish to Hugging Face (model repo)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO:  ${{ env.HF_REPO }}
        run: |
          python - << 'PY'
          import os
          from huggingface_hub import create_repo, upload_file, HfApi

          token   = os.environ["HF_TOKEN"]
          repo_id = os.environ["HF_REPO"]

          # create the repo if it doesn't exist
          api = HfApi()
          try:
              create_repo(repo_id, repo_type="model", exist_ok=True, token=token)
          except Exception:
              pass

          # push ONNX + tokenizer to consistent paths used by Space
          upload_file(
              path_or_fileobj="export/scraps.onnx",
              path_in_repo="export/scraps.onnx",
              repo_id=repo_id,
              repo_type="model",
              token=token,
          )
          upload_file(
              path_or_fileobj="tokenizer/bpe.json",
              path_in_repo="tokenizer/bpe.json",
              repo_id=repo_id,
              repo_type="model",
              token=token,
          )
          PY
